<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hub de Modelos IA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .custom-scrollbar::-webkit-scrollbar { width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    #configuration-panel, #loading-overlay, #delete-modal { display: none; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">
  <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 z-50 flex items-center justify-center">
    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
  </div>

  <div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40 flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto">
      <h2 class="text-xl font-bold mb-4">Confirmar Eliminaci√≥n</h2>
      <p class="mb-6 text-gray-600">¬øEst√°s seguro de que quieres eliminar este agente? Esta acci√≥n no se puede deshacer.</p>
      <div class="flex justify-end gap-4">
        <button id="cancel-delete-btn" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancelar</button>
        <button id="confirm-delete-btn" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700">Eliminar</button>
      </div>
    </div>
  </div>

  <div id="app" class="flex h-screen w-screen">
    <aside class="w-full md:w-1/3 lg:w-1/4 h-full bg-white border-r border-gray-200 flex flex-col p-6 shadow-lg">
      <div id="agent-library-panel" class="flex flex-col h-full">
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-2xl font-bold text-gray-900">Mis Agentes</h1>
          <button id="new-agent-btn" class="flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
            <span>Nuevo</span>
          </button>
        </div>
        <div class="flex-grow overflow-y-auto custom-scrollbar -mr-2 pr-2">
          <nav id="agent-list" class="space-y-1"></nav>
        </div>
      </div>

      <div id="configuration-panel" class="flex flex-col h-full">
        <div class="flex items-center mb-6">
          <button id="back-to-library-btn" class="p-2 rounded-full hover:bg-gray-100 mr-2"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-gray-600"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /></svg></button>
          <h2 id="config-panel-title" class="text-2xl font-bold text-gray-900">Crear Agente</h2>
        </div>
        <div class="flex-grow overflow-y-auto custom-scrollbar -mr-2 pr-2">
          <input type="hidden" id="editing-agent-id">
          <div class="mb-5">
            <label for="agent-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Agente</label>
            <input type="text" id="agent-name" placeholder="Ej: Experto en Marketing" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
          </div>
          <div class="mb-5">
            <label for="system-prompt" class="block text-sm font-medium text-gray-700 mb-1">Instrucciones</label>
            <textarea id="system-prompt" rows="8" placeholder="Eres un asistente experto..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition text-sm"></textarea>
          </div>
          <div class="mb-5">
            <label class="block text-sm font-medium text-gray-700 mb-2">Modo de Operaci√≥n</label>
            <div class="space-y-3" id="modes-container">
              <div class="p-4 border rounded-lg cursor-pointer" data-mode="fast"><h3 class="font-semibold text-gray-800">‚ö° R√°pido y Conciso</h3><p class="text-sm text-gray-600 mt-1">Ideal para res√∫menes y respuestas directas.</p></div>
              <div class="p-4 border rounded-lg cursor-pointer" data-mode="balanced"><h3 class="font-semibold text-gray-800">üß† Inteligente y Equilibrado</h3><p class="text-sm text-gray-600 mt-1">Recomendado para la mayor√≠a de tareas.</p></div>
              <div class="p-4 border rounded-lg cursor-pointer" data-mode="reasoning"><h3 class="font-semibold text-gray-800">üî¨ Razonamiento Profundo</h3><p class="text-sm text-gray-600 mt-1">Para an√°lisis complejos y multi-paso.</p></div>
              <div class="p-4 border rounded-lg cursor-pointer" data-mode="code"><h3 class="font-semibold text-gray-800">üíª Experto en C√≥digo</h3><p class="text-sm text-gray-600 mt-1">Generaci√≥n, depuraci√≥n y explicaci√≥n de c√≥digo.</p></div>
              <div class="p-4 border rounded-lg cursor-pointer" data-mode="creative"><h3 class="font-semibold text-gray-800">üé® Creativo y Visual</h3><p class="text-sm text-gray-600 mt-1">Brainstorming, escritura y generaci√≥n de im√°genes.</p></div>
            </div>
          </div>
          <div class="mb-5">
            <div class="relative flex items-start">
              <div class="flex h-6 items-center"><input id="advanced-toggle" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600"></div>
              <div class="ml-3 text-sm leading-6"><label for="advanced-toggle" class="font-medium text-gray-900">Ajustes Avanzados</label><p class="text-gray-500">Forzar el uso de un modelo espec√≠fico.</p></div>
            </div>
          </div>
          <div id="advanced-settings" class="hidden space-y-5 border-t border-gray-200 pt-5 mt-5">
            <div>
              <label for="llm-model" class="block text-sm font-medium text-gray-700 mb-1">Forzar Modelo</label>
              <select id="llm-model" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition bg-white">
                <optgroup label="OpenAI"><option value="gpt-4o">GPT-4o</option><option value="gpt-4o-mini">GPT-4o Mini</option></optgroup>
                <optgroup label="Anthropic"><option value="claude-3-opus-20240229">Claude 3 Opus</option><option value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet</option><option value="claude-3-haiku-20240307">Claude 3 Haiku</option></optgroup>
                <optgroup label="Google"><option value="gemini-1.5-pro-latest">Gemini 1.5 Pro</option><option value="gemini-1.5-flash-latest">Gemini 1.5 Flash</option></optgroup>
                <optgroup label="Mistral"><option value="codestral-latest">Codestral</option><option value="mistral-large-latest">Mistral Large</option><option value="mistral-small-latest">Mistral Small</option></optgroup>
                <optgroup label="Perplexity"><option value="llama-3-sonar-large-32k-online">Sonar Large</option><option value="llama-3-sonar-small-32k-online">Sonar Small</option></optgroup>
                <optgroup label="Grok"><option value="grok-1">Grok-1 (Llama 3 70B)</option></optgroup>
              </select>
            </div>
          </div>
        </div>
        <div class="mt-auto pt-4 border-t border-gray-200 flex justify-end gap-3">
          <button id="cancel-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">Cancelar</button>
          <button id="save-agent-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">Guardar Agente</button>
        </div>
      </div>
      <div id="user-profile-section" class="mt-auto pt-6 border-t border-gray-200"></div>
    </aside>

    <main class="w-full md:w-2/3 lg:w-3/4 h-full bg-gray-50 flex flex-col">
      <header class="flex items-center justify-between p-4 border-b border-gray-200 bg-white"><h2 id="chat-header-title" class="text-lg font-semibold text-gray-800">Selecciona un Agente</h2></header>
      <div class="flex-grow p-6 overflow-y-auto custom-scrollbar" id="chat-messages-container">
        <div id="chat-welcome-screen" class="flex flex-col items-center justify-center h-full text-center text-gray-500">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" class="w-24 h-24 mb-4"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" /></svg>
          <p>Selecciona un agente de la lista o crea uno nuevo para empezar a chatear.</p>
        </div>
        <div id="chat-messages" class="space-y-6"></div>
      </div>
      <div class="p-4 bg-white border-t border-gray-200">
        <div class="relative">
          <input id="chat-input" type="text" placeholder="Escribe tu mensaje..." class="w-full py-3 pl-4 pr-16 border border-gray-300 rounded-full focus:ring-2 focus:ring-indigo-500 transition" disabled>
          <button id="send-btn" class="absolute inset-y-0 right-2 flex items-center justify-center w-12 h-12 -my-2 text-white bg-indigo-600 rounded-full hover:bg-indigo-700 transition disabled:bg-indigo-300" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18" /></svg>
          </button>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // =========================
    // CONFIG
    // =========================
    // üëâ Proxy en Vercel:
    const N8N_WEBHOOK_URL = '/api/n8n';

    const firebaseConfig = {
      apiKey: "AIzaSyBb9h02F4r5avqYmwMu2YkMtrlvV8opFiM",
      authDomain: "ia-hub-3af71.firebaseapp.com",
      projectId: "ia-hub-3af71",
      storageBucket: "ia-hub-3af71.appspot.com",
      messagingSenderId: "399898564727",
      appId: "1:399898564727:web:f84642af69ac46a508ce72",
      measurementId: "G-75H0XST75Y"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // =========================
    // DOM
    // =========================
    const userProfileSection = document.getElementById('user-profile-section');
    const newAgentBtn = document.getElementById('new-agent-btn');
    const agentList = document.getElementById('agent-list');
    const agentLibraryPanel = document.getElementById('agent-library-panel');
    const configurationPanel = document.getElementById('configuration-panel');
    const backToLibraryBtn = document.getElementById('back-to-library-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const saveAgentBtn = document.getElementById('save-agent-btn');
    const agentNameInput = document.getElementById('agent-name');
    const systemPromptInput = document.getElementById('system-prompt');
    const modesContainer = document.getElementById('modes-container');
    const advancedToggle = document.getElementById('advanced-toggle');
    const advancedSettings = document.getElementById('advanced-settings');
    const llmModelSelect = document.getElementById('llm-model');
    const chatHeaderTitle = document.getElementById('chat-header-title');
    const chatWelcomeScreen = document.getElementById('chat-welcome-screen');
    const chatMessages = document.getElementById('chat-messages');
    const chatMessagesContainer = document.getElementById('chat-messages-container');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const loadingOverlay = document.getElementById('loading-overlay');
    const deleteModal = document.getElementById('delete-modal');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const configPanelTitle = document.getElementById('config-panel-title');
    const editingAgentIdInput = document.getElementById('editing-agent-id');

    // =========================
    // STATE
    // =========================
    let currentUser = null;
    let currentAgent = null;
    let localAgents = [];
    let conversationHistory = [];
    let unsubscribeAgentListener = null;
    let agentIdToDelete = null;
    let isSending = false;

    // =========================
    // UI helpers
    // =========================
    const showLoading = (show) => { loadingOverlay.style.display = show ? 'flex' : 'none'; };

    const showConfigPanel = (isEditing = false) => {
      configPanelTitle.textContent = isEditing ? 'Editar Agente' : 'Crear Agente';
      saveAgentBtn.textContent = isEditing ? 'Actualizar Agente' : 'Guardar Agente';
      agentLibraryPanel.style.display = 'none';
      configurationPanel.style.display = 'flex';
    };

    const showLibraryPanel = () => {
      configurationPanel.style.display = 'none';
      agentLibraryPanel.style.display = 'flex';
      resetForm();
    };

    const showDeleteModal = (show) => { deleteModal.style.display = show ? 'flex' : 'none'; };

    const resetForm = () => {
      editingAgentIdInput.value = '';
      agentNameInput.value = '';
      systemPromptInput.value = '';
      advancedToggle.checked = false;
      advancedSettings.style.display = 'none';
      selectMode('balanced');
    };

    const selectMode = (mode) => {
      modesContainer.querySelectorAll('.p-4').forEach(div => {
        div.classList.remove('border-indigo-500', 'bg-indigo-50', 'ring-2', 'ring-indigo-500');
        div.classList.add('border-gray-300', 'hover:border-indigo-500');
      });
      const selectedDiv = modesContainer.querySelector(`[data-mode="${mode}"]`);
      if (selectedDiv) {
        selectedDiv.classList.add('border-indigo-500', 'bg-indigo-50', 'ring-2', 'ring-indigo-500');
        selectedDiv.classList.remove('border-gray-300', 'hover:border-indigo-500');
      }
    };

    const updateLoginUI = (user) => {
      if (user) {
        userProfileSection.innerHTML = `
          <div class="flex items-center gap-3">
            <img src="${user.photoURL}" alt="Foto de perfil" class="w-10 h-10 rounded-full">
            <div class="flex-grow truncate">
              <p class="font-semibold text-sm text-gray-800 truncate">${user.displayName}</p>
              <p class="text-xs text-gray-500 truncate">${user.email}</p>
            </div>
            <button id="logout-btn" class="p-2 rounded-full hover:bg-gray-100" title="Cerrar sesi√≥n">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-600"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" /></svg>
            </button>
          </div>`;
        newAgentBtn.disabled = false;
        document.getElementById('logout-btn').addEventListener('click', handleSignOut);
      } else {
        userProfileSection.innerHTML = `
          <button id="login-btn" class="w-full flex items-center justify-center gap-3 px-4 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-150">
            <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C41.38,36.14,44,30.63,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
            <span class="text-sm font-medium text-gray-700">Iniciar sesi√≥n con Google</span>
          </button>`;
        newAgentBtn.disabled = true;
        agentList.innerHTML = '<p class="text-center text-gray-500 p-4">Inicia sesi√≥n para ver tus agentes.</p>';
        document.getElementById('login-btn').addEventListener('click', handleSignIn);
      }
    };

    const renderAgents = (agents) => {
      localAgents = agents;
      if (agents.length === 0) {
        agentList.innerHTML = '<p class="text-center text-gray-500 p-4">No has creado ning√∫n agente.</p>';
        return;
      }
      agentList.innerHTML = agents.map(agent => `
        <div class="agent-item group flex items-center p-3 text-gray-600 hover:bg-gray-100 rounded-lg cursor-pointer" data-id="${agent.id}">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 shrink-0"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" /></svg>
          <span class="ml-3 truncate flex-grow">${agent.name}</span>
          <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
            <button class="edit-btn p-1 rounded hover:bg-gray-200" data-id="${agent.id}"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 pointer-events-none"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg></button>
            <button class="delete-btn p-1 rounded hover:bg-gray-200" data-id="${agent.id}"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 pointer-events-none"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button>
          </div>
        </div>`).join('');
    };

    const appendMessage = (sender, text) => {
      const userIcon = `<div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 font-bold text-xl shrink-0">T</div>`;
      const assistantIcon = `<div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold text-xl shrink-0">A</div>`;
      const typingIndicatorHTML = `<div id="typing-indicator" class="flex items-start gap-4">${assistantIcon}<div class="bg-white p-4 rounded-lg rounded-tl-none shadow-sm"><div class="flex items-center space-x-1"><div class="w-2 h-2 rounded-full bg-gray-400 animate-bounce" style="animation-delay:-0.3s;"></div><div class="w-2 h-2 rounded-full bg-gray-400 animate-bounce" style="animation-delay:-0.15s;"></div><div class="w-2 h-2 rounded-full bg-gray-400 animate-bounce"></div></div></div></div>`;

      if (sender === 'typing') {
        const old = document.getElementById('typing-indicator');
        if (old) old.remove();
      }

      let html;
      if (sender === 'user') {
        html = `<div class="flex items-start gap-4 flex-row-reverse">${userIcon}<div class="bg-indigo-500 text-white p-4 rounded-lg rounded-tr-none shadow-sm max-w-xl"><p class="text-sm">${text}</p></div></div>`;
      } else if (sender === 'assistant') {
        html = `<div class="flex items-start gap-4">${assistantIcon}<div class="bg-white p-4 rounded-lg rounded-tl-none shadow-sm max-w-xl"><p class="text-sm">${text}</p></div></div>`;
      } else {
        html = typingIndicatorHTML;
      }

      chatMessages.insertAdjacentHTML('beforeend', html);
      chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
    };

    // =========================
    // Firebase/Auth
    // =========================
    const handleSignIn = async () => { try { await signInWithPopup(auth, provider); } catch (e) { console.error("Error al iniciar sesi√≥n:", e); } };
    const handleSignOut = async () => { try { await signOut(auth); } catch (e) { console.error("Error al cerrar sesi√≥n:", e); } };

    const handleSaveAgent = async () => {
      if (!currentUser) return alert("Debes iniciar sesi√≥n.");
      const name = agentNameInput.value.trim();
      const instructions = systemPromptInput.value.trim();
      if (!name || !instructions) return alert("El nombre y las instrucciones son obligatorios.");

      const agentData = {
        name,
        instructions,
        mode: modesContainer.querySelector('.ring-2')?.dataset.mode || 'balanced',
        advanced: advancedToggle.checked,
        forcedModel: advancedToggle.checked ? llmModelSelect.value : null,
        userId: currentUser.uid,
      };

      showLoading(true);
      const agentId = editingAgentIdInput.value;
      try {
        if (agentId) {
          await updateDoc(doc(db, "agents", agentId), agentData);
        } else {
          agentData.createdAt = serverTimestamp();
          await addDoc(collection(db, "agents"), agentData);
        }
        showLibraryPanel();
      } catch (e) {
        console.error("Error al guardar el agente: ", e);
        alert("Hubo un error al guardar el agente.");
      } finally {
        showLoading(false);
      }
    };

    const setupAgentListener = (user) => {
      if (unsubscribeAgentListener) unsubscribeAgentListener();
      if (user) {
        const q = query(collection(db, "agents"), where("userId", "==", user.uid));
        unsubscribeAgentListener = onSnapshot(q, (querySnapshot) => {
          const agents = [];
          querySnapshot.forEach((doc) => agents.push({ id: doc.id, ...doc.data() }));
          renderAgents(agents);

          if (currentAgent) {
            const updated = agents.find(a => a.id === currentAgent.id);
            if (updated) {
              currentAgent = updated;
              chatHeaderTitle.textContent = `Chat: ${currentAgent.name}`;
            } else {
              currentAgent = null;
              chatHeaderTitle.textContent = "Selecciona un Agente";
              chatWelcomeScreen.style.display = 'flex';
              chatMessages.innerHTML = '';
              chatInput.disabled = true;
              sendBtn.disabled = true;
            }
          }
        }, (error) => console.error("Error al obtener agentes:", error));
      }
    };

    const handleSelectAgent = (agent) => {
      currentAgent = agent;
      if (!currentAgent) return;

      document.querySelectorAll('.agent-item').forEach(item => {
        item.classList.toggle('bg-indigo-50', item.dataset.id === currentAgent.id);
        item.classList.toggle('text-indigo-800', item.dataset.id === currentAgent.id);
        item.classList.toggle('font-semibold', item.dataset.id === currentAgent.id);
      });

      chatHeaderTitle.textContent = `Chat: ${currentAgent.name}`;
      chatWelcomeScreen.style.display = 'none';
      chatMessages.innerHTML = '';
      conversationHistory = [];
      appendMessage('assistant', `¬°Hola! Soy tu agente "${currentAgent.name}". ¬øEn qu√© puedo ayudarte?`);
      chatInput.disabled = false;
      sendBtn.disabled = false;
      chatInput.focus();
    };

    const handleEditAgent = (agentId) => {
      const agentToEdit = localAgents.find(a => a.id === agentId);
      if (!agentToEdit) return;

      editingAgentIdInput.value = agentId;
      agentNameInput.value = agentToEdit.name;
      systemPromptInput.value = agentToEdit.instructions;
      selectMode(agentToEdit.mode || 'balanced');
      advancedToggle.checked = agentToEdit.advanced;
      advancedSettings.style.display = agentToEdit.advanced ? 'block' : 'none';
      if (agentToEdit.advanced) llmModelSelect.value = agentToEdit.forcedModel || llmModelSelect.value;
      showConfigPanel(true);
    };

    const handleDeleteAgent = (agentId) => {
      agentIdToDelete = agentId;
      showDeleteModal(true);
    };

    const confirmDelete = async () => {
      if (!agentIdToDelete) return;
      showLoading(true);
      try {
        await deleteDoc(doc(db, "agents", agentIdToDelete));
      } catch (error) {
        console.error("Error al eliminar agente:", error);
      } finally {
        agentIdToDelete = null;
        showDeleteModal(false);
        showLoading(false);
      }
    };

    // ===== POST con logs de depuraci√≥n (raw + parsed) =====
    async function postJSON(url, payload, timeoutMs = 60000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: controller.signal
        });

        const raw = await res.text(); // leer SOLO una vez
        console.groupCollapsed('[n8n raw]', res.status, res.statusText);
        try { console.log('headers', Object.fromEntries(res.headers.entries())); } catch {}
        console.log('body:', raw);
        console.groupEnd();

        let data;
        try {
          data = JSON.parse(raw);
        } catch (e) {
          data = { ok: false, parseError: e.message, raw };
        }

        console.log('[n8n parsed]', data);

        if (!res.ok) {
          const msg = (data && (data.error || data.message)) || raw || 'Unknown error';
          throw new Error(`HTTP ${res.status} ${res.statusText} - ${msg}`);
        }

        return data;
      } finally {
        clearTimeout(id);
      }
    }

    const handleSendMessage = async () => {
      if (isSending) return;
      const messageText = chatInput.value.trim();
      if (!messageText || !currentAgent) return;

      isSending = true;
      chatInput.disabled = true;
      sendBtn.disabled = true;

      appendMessage('user', messageText);
      chatInput.value = '';
      appendMessage('typing');
      conversationHistory.push({ role: 'user', content: messageText });

      try {
        const data = await postJSON(N8N_WEBHOOK_URL, {
          agent: currentAgent,
          history: conversationHistory
        });

        if (data && data.debug) {
          console.groupCollapsed('[n8n debug]');
          console.log(data.debug);
          console.groupEnd();
        }

        const typing = document.getElementById('typing-indicator');
        if (typing) typing.remove();

        const assistantResponse =
          (data && (data.response ?? data.reply ?? data.message)) ||
          "No se recibi√≥ una respuesta v√°lida de n8n.";

        appendMessage('assistant', assistantResponse);
        conversationHistory.push({ role: 'assistant', content: assistantResponse });
      } catch (error) {
        console.error("Error al llamar al Webhook de n8n:", error);
        const typing = document.getElementById('typing-indicator');
        if (typing) typing.remove();
        appendMessage('assistant', `Lo siento, ha ocurrido un error: ${error.message}`);
      } finally {
        isSending = false;
        chatInput.disabled = false;
        sendBtn.disabled = false;
        chatInput.focus();
      }
    };

    // Auth listener
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      updateLoginUI(user);
      setupAgentListener(user);

      currentAgent = null;
      chatHeaderTitle.textContent = "Selecciona un Agente";
      chatWelcomeScreen.style.display = 'flex';
      chatMessages.innerHTML = '';
      chatInput.disabled = true;
      sendBtn.disabled = true;
    });

    // Listeners
    newAgentBtn.addEventListener('click', () => showConfigPanel(false));
    backToLibraryBtn.addEventListener('click', showLibraryPanel);
    cancelBtn.addEventListener('click', showLibraryPanel);
    saveAgentBtn.addEventListener('click', handleSaveAgent);
    sendBtn.addEventListener('click', handleSendMessage);
    chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSendMessage(); });
    advancedToggle.addEventListener('change', () => { advancedSettings.style.display = advancedToggle.checked ? 'block' : 'none'; });
    modesContainer.addEventListener('click', (event) => {
      const selectedMode = event.target.closest('.p-4');
      if (selectedMode) selectMode(selectedMode.dataset.mode);
    });
    agentList.addEventListener('click', (e) => {
      const agentItem = e.target.closest('.agent-item');
      const editBtn = e.target.closest('.edit-btn');
      const deleteBtn = e.target.closest('.delete-btn');

      if (deleteBtn) {
        handleDeleteAgent(deleteBtn.dataset.id);
      } else if (editBtn) {
        handleEditAgent(editBtn.dataset.id);
      } else if (agentItem) {
        const agent = localAgents.find(a => a.id === agentItem.dataset.id);
        handleSelectAgent(agent);
      }
    });
    cancelDeleteBtn.addEventListener('click', () => showDeleteModal(false));
    confirmDeleteBtn.addEventListener('click', confirmDelete);
  </script>
</body>
</html>
